let p = document.querySelector("main > div > div > div > div")
let c = p.children
// loop through c to see if they are p elements or pre elements
let page = []
let first_time = true
function save_thread(human, h) {
    if(human){
        let text = h.innerText // saves as plain text
        page.push(text)
    }
    if(!human){
        let text = h.firstChild.children[1].firstChild.firstChild.innerHTML // saves as html
        page.push(text)
    }
}
function getDate() { // generated by ChatGPT
    var date = new Date();
    var options = { year: 'numeric', month: 'long', day: 'numeric' };
    return date.toLocaleString('default', options);
}
function getTime(){ // generated by ChatGPT
    var currentDate = new Date();
    var options = {
        hour12: true,
        hour: "numeric",
        minute: "numeric"
    };
    var timeString = currentDate.toLocaleTimeString("default", options);
    return timeString
}

function save_page(){
    page = []
    for(let i = 0; i < c.length; i++){
        let human = i % 2 === 0;
        save_thread(human, c[i])
    }
    let thread = {date: getDate(), time: getTime(), convo: page, favorite: false}
    chrome.storage.local.get({threads: null}).then((result) => {
        let t = result.threads
        if (t !== null) {
            let t = result.threads
            if (first_time) {
                t.push(thread)
                first_time = false
            }
            else {
                t[t.length - 1] = thread
            }
            chrome.storage.local.set({threads: t})
        }
        else {
            let t = [page]
            chrome.storage.local.set({threads: t})
        }
    });}

document.addEventListener('keydown', function(event) { // generated by ChatGPT
    // Check if the pressed key was the Enter key
    if (event.key === 'Enter') {
        setTimeout(save_page, 500)
    }
});

let main = p
var interval;
main.addEventListener('DOMSubtreeModified', function() { // generated by ChatGPT
    clearInterval(interval)
    interval = setInterval(function() {
        save_page()
    }, 7000);

    setTimeout(function() {
        clearInterval(interval);
    }, 80000);

});
let reset = document.querySelector("nav").firstChild
reset.addEventListener('click', function() {
    first_time = true
})